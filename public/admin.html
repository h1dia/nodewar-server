<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹ ç‚¹æˆ¦ãã‚“ ç®¡ç†ç”»é¢</title>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            background: #f0f0f0; 
            max-width: 800px; 
            margin: 0 auto; 
            color: #333;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            position: relative; 
        }
        h1 { margin-top: 0; font-size: 1.5rem; }
        
        #save-status {
            position: absolute; top: 35px; right: 30px;
            font-weight: bold; font-size: 1rem; color: #888;
            display: flex; align-items: center; gap: 5px;
        }
        #save-status.saving { color: #e67e22; }
        #save-status.saved { color: #27ae60; }
        #save-status.error { color: #c0392b; }

        .input-group { 
            margin-bottom: 30px; 
            padding: 20px; 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
        }

        .row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 15px; 
            align-items: center; 
            transition: all 0.3s; 
        }
        .row.fade-out { opacity: 0; transform: translateX(20px); }
        
        input[type="text"], input[type="number"] { 
            padding: 15px;          
            font-size: 1.2rem;      
            border: 2px solid #ccc; 
            border-radius: 8px;     
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: #c6a06d;  
        }

        input[type="text"] { flex: 2; }
        input[type="number"] { padding: 15px; }
        .minute-input { flex: 1; min-width: 100px; }
        
        button { 
            padding: 15px 25px;     
            font-size: 1rem;
            cursor: pointer; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            transition: 0.2s; 
        }
        
        .add-btn { 
            background: #4CAF50; color: white; width: 100%; 
            padding: 15px; margin-top: 15px; font-size: 1.1rem; 
        }
        .add-btn:hover { background: #45a049; }
        
        .del-btn { background: #ff5252; color: white; padding: 15px 20px; }
        .del-btn:hover { background: #ff1744; }

        .reset-btn { 
            background: #fff; border: 2px solid #ff5252; color: #ff5252; 
            margin-top: 30px; font-size: 0.9rem; padding: 10px 20px;
        }
        .reset-btn:hover { background: #ff5252; color: white; }

        a { color: #666; text-decoration: none; font-size: 1rem; display: inline-block; padding: 10px; }
        a:hover { text-decoration: underline; color: #c6a06d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ ç®¡ç†ç”»é¢</h1>
        <div id="save-status">èª­ã¿è¾¼ã¿ä¸­...</div>

        <div class="input-group">
            <label style="font-weight:bold; font-size:1.1rem;">é…å»¶ç§’æ•° (ç§’):</label>
            <input type="number" id="delay" value="0" style="width: 100px; margin-left:10px;">
        </div>

        <h3>ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚¹ãƒˆ (21:00åŸºæº–)</h3>
        <p style="font-size:0.9rem; color:#666; margin-top:-10px; margin-bottom: 20px;">
            ã€Œ20ã€ã¨å…¥åŠ› â†’ 21:00 + 20åˆ† + 1åˆ† = <b>21:21çµ‚äº†</b>
        </p>
        
        <div id="timer-list"></div>
        
        <button class="add-btn" onclick="addNewRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>
        
        <div style="text-align: right;">
            <button class="reset-btn" onclick="resetAllTimers()">âš ï¸ å…¨ã¦å‰Šé™¤ (ãƒªã‚»ãƒƒãƒˆ)</button>
        </div>
        
        <div style="margin-top:20px; text-align:right; border-top: 1px solid #eee; padding-top: 15px;">
            <a href="/" target="_blank">å…¬é–‹ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª &rarr;</a>
        </div>
    </div>

    <script>
        let saveTimeout = null;

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        fetch('/api/data')
            .then(res => res.json())
            .then(data => {
                document.getElementById('delay').value = data.delaySeconds;
                if(data.timers && data.timers.length > 0){
                    data.timers.forEach(t => createRow(t.label, t.minutes));
                } else {
                    createRow();
                }
                updateStatus('saved', 'âœ… æœ€æ–°ã®çŠ¶æ…‹ã§ã™');
            })
            .catch(() => updateStatus('error', 'âŒ èª­ã¿è¾¼ã¿å¤±æ•—'));

        function createRow(label = "", minutes = "") {
            const div = document.createElement('div');
            div.className = 'row';
            div.innerHTML = `
                <input type="text" placeholder="ç ¦å" value="${label}" oninput="triggerSave()">
                <input type="number" class="minute-input" placeholder="åˆ†" value="${minutes}" oninput="triggerSave()">
                <button class="del-btn" onclick="deleteRow(this)">å‰Šé™¤</button>
            `;
            document.getElementById('timer-list').appendChild(div);
        }

        function addNewRow() {
            createRow();
            // è¿½åŠ ç›´å¾Œã¯ä¿å­˜ã—ãªã„ï¼ˆç©ºè¡Œã®ãŸã‚ï¼‰
        }

        function deleteRow(btn) {
            const row = btn.parentElement;
            row.classList.add('fade-out');
            setTimeout(() => {
                row.remove();
                triggerSave(0);
            }, 300);
        }

        function resetAllTimers() {
            if (!confirm("ã€è­¦å‘Šã€‘\nç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                return;
            }
            const list = document.getElementById('timer-list');
            list.innerHTML = '';
            triggerSave(0);
            setTimeout(() => { createRow(); }, 500); 
        }

        document.getElementById('delay').addEventListener('input', () => triggerSave());

        function triggerSave(delayMs = 1000) {
            updateStatus('saving', 'â³ ä¿å­˜ä¸­...');
            if (saveTimeout) clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(() => {
                performSave();
            }, delayMs);
        }

        function performSave() {
            const delaySeconds = parseInt(document.getElementById('delay').value) || 0;
            const timers = [];
            document.querySelectorAll('#timer-list .row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value !== "") {
                    timers.push({ label: inputs[0].value, minutes: parseInt(inputs[1].value, 10) });
                }
            });

            fetch('/api/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ delaySeconds, timers })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) updateStatus('saved', 'âœ… ä¿å­˜å®Œäº†');
                else updateStatus('error', 'âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼');
            })
            .catch(() => updateStatus('error', 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼'));
        }

        function updateStatus(type, text) {
            const el = document.getElementById('save-status');
            el.className = type;
            el.textContent = text;
        }

        // â˜…â˜…â˜… Enterã‚­ãƒ¼ã«ã‚ˆã‚‹ç§»å‹•ãƒ»è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        document.addEventListener('keydown', function(e) {
            // Enterä»¥å¤–ã¯ç„¡è¦–
            if (e.key !== 'Enter') return;
            
            // å…¥åŠ›æ¬„ã§ãªã‘ã‚Œã°ç„¡è¦–
            if (e.target.tagName !== 'INPUT') return;

            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡ç­‰ã‚’é˜²ã

            const delayInput = document.getElementById('delay');
            const allInputs = Array.from(document.querySelectorAll('#timer-list input'));
            
            // ã‚±ãƒ¼ã‚¹1: é…å»¶ç§’æ•°ã«ã„ã‚‹å ´åˆ -> æœ€åˆã®ã‚¿ã‚¤ãƒãƒ¼è¡Œã¸
            if (e.target === delayInput) {
                if (allInputs.length > 0) allInputs[0].focus();
                else addNewRow(); // è¡ŒãŒãªã‘ã‚Œã°ä½œã‚‹
                return;
            }

            // ã‚±ãƒ¼ã‚¹2: ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚¹ãƒˆå†…ã«ã„ã‚‹å ´åˆ
            const currentIndex = allInputs.indexOf(e.target);
            if (currentIndex !== -1) {
                // æ¬¡ã®è¦ç´ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (currentIndex < allInputs.length - 1) {
                    allInputs[currentIndex + 1].focus();
                } else {
                    // æœ€å¾Œã®è¦ç´ ã®å ´åˆ -> æ–°ã—ã„è¡Œã‚’è¿½åŠ ã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                    addNewRow();
                    // DOMæ›´æ–°ã‚’å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•
                    setTimeout(() => {
                        const newInputs = document.querySelectorAll('#timer-list input');
                        // è¿½åŠ ã•ã‚ŒãŸè¡Œã®å·¦å´(ç ¦å)ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                        newInputs[newInputs.length - 2].focus(); 
                    }, 50);
                }
            }
        });
    </script>
</body>
</html>